# nginx snippet to serve /home, /parse (frontend SPA) and proxy /parse/upload and /grafana
# Copy this file to /etc/nginx/conf.d/piazzati_parse_grafana_home.conf on the server and reload nginx

server {
    listen 80 default_server;
    server_name _;

    # Root where the frontend build and static files will live on the server
    root /var/www/piazzati;
    index index.html home.html;

    # Default: redirect root to /home
    location = / {
        return 302 /home;
    }

    # Serve the simple home menu (deploy/home.html -> /var/www/piazzati/home.html)
    # Use a prefix match so both /home and /home/ work
    location /home {
        # try the incoming URI first, then fall back to the static home page
        try_files $uri /home.html =404;
    }

    # Normalize trailing slash for /home/
    location = /home/ {
        return 302 /home;
    }

    # Serve the frontend single-page app from /parse/
    # Expect files to be in /var/www/piazzati (build output of the frontend)
    location /parse/ {
        # try direct file first, otherwise fall back to the SPA entry under /parse
        try_files $uri $uri/ /parse/index.html;
    }

    # Allow POSTs from the frontend to the backend upload endpoint
    location /parse/upload {
        proxy_pass http://127.0.0.1:8000/parse/upload;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    # Proxy Grafana (assumes Grafana listens on localhost:3000)
    location /grafana/ {
        proxy_pass http://127.0.0.1:3000/;
        # Preserve the original Host header (use $http_host so Grafana sees the public host)
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Websocket support for Grafana
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # Let nginx rewrite upstream Location headers if needed
        proxy_redirect default;
    }

    # Optional: static images used by the site (e.g. piazzati.it.png)
    location /static/ {
        alias /var/www/piazzati/static/;
        access_log off;
        expires 7d;
    }

    # Basic security headers for the site
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
}
